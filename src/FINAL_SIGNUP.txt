// User signup
app.post('/make-server-95a96d8e/signup', async (c) => {
  try {
    const body = await c.req.json();
    const { email, password, name } = body;

    const { data, error } = await supabase.auth.admin.createUser({
      email,
      password,
      user_metadata: { name },
      // Automatically confirm the user's email since an email server hasn't been configured.
      email_confirm: true,
    });

    if (error) {
      console.log('Error creating user:', error);
      return c.json({ success: false, error: error.message }, 400);
    }

    // Send welcome email
    try {
      const emailSubject = 'ğŸ‰ Welcome to Our Family - AnimeDropZone';
      const emailBody = `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #1a0033 0%, #000000 100%); color: #ffffff; border: 2px solid #9333ea; border-radius: 12px; overflow: hidden;">
          <div style="background: linear-gradient(90deg, #9333ea 0%, #ec4899 50%, #9333ea 100%); padding: 40px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸŒ</div>
            <h1 style="margin: 0; font-size: 36px; color: #ffffff; text-shadow: 0 4px 20px rgba(0,0,0,0.5);">AnimeDropZone</h1>
            <p style="margin: 10px 0 0 0; font-size: 16px; color: #f3e8ff;">Your Anime Paradise Awaits</p>
          </div>
          <div style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(147, 51, 234, 0.2) 100%); padding: 40px; text-align: center; border-bottom: 2px solid rgba(147, 51, 234, 0.3);">
            <div style="font-size: 64px; margin-bottom: 15px;">ğŸ‰</div>
            <h2 style="margin: 0 0 15px 0; color: #ec4899; font-size: 32px;">Welcome to Our Family!</h2>
            <p style="margin: 0; color: #e5e7eb; font-size: 20px;"><strong style="color: #a855f7;">Hello ${name || 'Anime Fan'}!</strong></p>
            <p style="margin: 15px 0 0 0; color: #d1d5db; font-size: 16px;">We're absolutely thrilled to have you join us! ğŸ’œ</p>
          </div>
          <div style="padding: 40px 30px;">
            <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%); border-left: 4px solid #22c55e; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
              <p style="margin: 0; color: #4ade80; font-size: 16px;"><strong>âœ“ Account Successfully Created!</strong></p>
              <p style="margin: 10px 0 0 0; color: #d1d5db; font-size: 14px;">Your email: <strong style="color: #a855f7;">${email}</strong></p>
            </div>
            <p style="color: #e5e7eb; font-size: 16px; line-height: 1.8; margin: 0 0 25px 0;">Welcome to the ultimate destination for premium anime merchandise! You're now part of an amazing community of passionate anime fans.</p>
            <div style="background: rgba(147, 51, 234, 0.1); border: 1px solid rgba(147, 51, 234, 0.3); border-radius: 10px; padding: 25px; margin: 30px 0;">
              <h3 style="margin: 0 0 20px 0; color: #a855f7; font-size: 20px;">ğŸ¯ What You Can Do Now:</h3>
              <div style="background: rgba(236, 72, 153, 0.1); border-left: 4px solid #ec4899; border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                <p style="margin: 0; color: #ffffff; font-size: 15px;"><strong style="color: #f9a8d4;">âš”ï¸ Browse Premium Figures & Katanas</strong></p>
                <p style="margin: 5px 0 0 0; color: #d1d5db; font-size: 14px;">Discover authentic collectibles from your favorite anime</p>
              </div>
              <div style="background: rgba(147, 51, 234, 0.1); border-left: 4px solid #9333ea; border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                <p style="margin: 0; color: #ffffff; font-size: 15px;"><strong style="color: #a855f7;">ğŸ¨ Exclusive Merchandise</strong></p>
                <p style="margin: 5px 0 0 0; color: #d1d5db; font-size: 14px;">Limited edition items and custom clothing</p>
              </div>
              <div style="background: rgba(236, 72, 153, 0.1); border-left: 4px solid #ec4899; border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                <p style="margin: 0; color: #ffffff; font-size: 15px;"><strong style="color: #f9a8d4;">ğŸ“¦ Track Your Orders</strong></p>
                <p style="margin: 5px 0 0 0; color: #d1d5db; font-size: 14px;">Real-time tracking and updates</p>
              </div>
              <div style="background: rgba(147, 51, 234, 0.1); border-left: 4px solid #9333ea; border-radius: 6px; padding: 15px;">
                <p style="margin: 0; color: #ffffff; font-size: 15px;"><strong style="color: #a855f7;">ğŸ’œ Save Your Favorites</strong></p>
                <p style="margin: 5px 0 0 0; color: #d1d5db; font-size: 14px;">Create wishlists for your dream items</p>
              </div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.15) 0%, rgba(147, 51, 234, 0.15) 100%); border: 2px solid rgba(236, 72, 153, 0.4); border-radius: 10px; padding: 25px; margin: 30px 0; text-align: center;">
              <div style="font-size: 32px; margin-bottom: 10px;">ğŸ</div>
              <h3 style="margin: 0 0 10px 0; color: #ec4899; font-size: 22px;">Special Welcome Gift!</h3>
              <p style="margin: 0 0 15px 0; color: #e5e7eb; font-size: 16px;">As a new family member, keep an eye on your inbox for exclusive deals and early access!</p>
              <p style="margin: 0; color: #a855f7; font-size: 14px;">ğŸŒŸ First-time customers get priority support ğŸŒŸ</p>
            </div>
            <div style="text-align: center; margin: 40px 0 30px 0;">
              <a href="https://animedropzone.com" style="display: inline-block; background: linear-gradient(90deg, #9333ea 0%, #ec4899 100%); color: #ffffff; text-decoration: none; padding: 18px 50px; border-radius: 50px; font-size: 18px; font-weight: bold; box-shadow: 0 10px 30px rgba(236, 72, 153, 0.4);">ğŸ›ï¸ Start Shopping Now</a>
            </div>
            <div style="background: rgba(147, 51, 234, 0.05); border: 1px solid rgba(147, 51, 234, 0.2); border-radius: 8px; padding: 20px; margin: 30px 0;">
              <p style="margin: 0 0 10px 0; color: #e5e7eb; font-size: 14px;"><strong>Your Account Details:</strong></p>
              <p style="margin: 5px 0; color: #9ca3af; font-size: 13px;">Email: ${email}</p>
              <p style="margin: 5px 0; color: #9ca3af; font-size: 13px;">Name: ${name || 'Anime Fan'}</p>
              <p style="margin: 5px 0; color: #9ca3af; font-size: 13px;">Member Since: ${new Date().toLocaleDateString()}</p>
            </div>
            <div style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%); border-radius: 8px; padding: 25px; text-align: center; margin-top: 30px;">
              <p style="margin: 0 0 10px 0; color: #ec4899; font-size: 18px; font-weight: bold;">Thank You for Joining Us! ğŸ’œ</p>
              <p style="margin: 0; color: #d1d5db; font-size: 14px;">Welcome to the family!</p>
            </div>
          </div>
          <div style="background: rgba(0, 0, 0, 0.4); padding: 30px; text-align: center; border-top: 1px solid rgba(147, 51, 234, 0.3);">
            <p style="margin: 0 0 10px 0; color: #a855f7; font-size: 20px; font-weight: bold;">AnimeDropZone</p>
            <p style="margin: 0 0 15px 0; color: #9ca3af; font-size: 14px;">Your Trusted Source for Premium Anime Merchandise</p>
            <p style="margin: 15px 0 0 0; color: #6b7280; font-size: 12px;">Â© 2025 AnimeDropZone. All rights reserved.<br>This email was sent to ${email}</p>
          </div>
        </div>
      `;

      await sendEmail(email, emailSubject, emailBody);
      console.log(`âœ… Welcome email sent to ${email}`);
    } catch (emailError) {
      console.error('Error sending welcome email:', emailError);
    }

    return c.json({ success: true, user: data.user });
  } catch (error) {
    console.log('Error during signup:', error);
    return c.json({ success: false, error: String(error) }, 500);
  }
});
